<!-- receive.html -->
<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Nh·∫≠n tin nh·∫Øn - Web c·ªë ƒë·ªãnh</title>
<style>
  body{
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    margin:0;
    padding:0;
    background:#f7fafc;
    -webkit-text-size-adjust: 100%;
    display:flex;
    flex-direction:column;
    min-height:100vh;
  }
  .card{
    flex:1;
    max-width:95%;
    margin:12px auto;
    padding:18px;
    border-radius:12px;
    box-shadow:0 8px 30px rgba(2,6,23,0.06);
    background:#fff;
    box-sizing:border-box;
  }
  .muted{
    color:#6b7280;
    font-size:14px;
    word-break: break-word;
  }
  #messageBox{
    margin-top:12px;
    padding:12px;
    border-radius:10px;
    background:#fff;
    border:1px solid #eef2f7;
    min-height:50px;
    word-break:break-word;
    font-size:16px;
    line-height:1.4;
    word-wrap: break-word;
  }
  #autoCopyMsg{
    margin-top:8px;
    color:green;
    display:block;
    font-size:14px;
  }
  #toast{
    position:fixed;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    background:#2563eb;
    color:#fff;
    padding:12px 20px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    display:none;
    z-index:9999;
    font-size:14px;
  }
  #openLinkBtn{
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    padding:16px;
    border:none;
    background:#2563eb;
    color:#fff;
    font-size:18px;
    cursor:pointer;
    text-align:center;
    border-top-left-radius:12px;
    border-top-right-radius:12px;
    z-index:999;
  }
</style>
</head>
<body>
<div class="card">
  <h2 style="font-size:18px;">Tin nh·∫Øn m·ªõi nh·∫•t</h2>
  <div id="messageBox">
    <div id="messageContent">ƒêang t·∫£i...</div>
  </div>
  <div class="muted">ƒê√£ t·∫°o: <span id="createdAt">‚Äî</span></div>
  <div id="autoCopyMsg">‚úî N·ªôi dung ƒë√£ ƒë∆∞·ª£c sao ch√©p v√†o b·ªô nh·ªõ t·∫°m</div>
</div>
<button id="openLinkBtn">M·ªü link</button>
<div id="toast"></div>
<script type="module">
const firebaseConfig = { 
  apiKey : "AIzaSyB9elXt44pt-DGYygIOWQog8XE-YqQO_I8" , 
  authDomain : "email-sync-tool.firebaseapp.com" , 
  databaseURL : "https://email-sync-tool-default-rtdb.asia-southeast1.firebasedatabase.app" , 
  projectId : "email-sync-tool" , 
  storageBucket : "email-sync-tool.firebasestorage.app" , 
  messagingSenderId : "902586987378" , 
  appId : "1:902586987378:web:b151f5d50773490816e3eb" 
};


import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getFirestore, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const messageContent = document.getElementById('messageContent');
const createdAtEl = document.getElementById('createdAt');
const autoCopyMsg = document.getElementById('autoCopyMsg');
const toast = document.getElementById('toast');
const openLinkBtn = document.getElementById('openLinkBtn');

let lastMessage = '';

function showToast(msg){
  toast.textContent = msg;
  toast.style.display='block';
  setTimeout(()=>{ toast.style.display='none'; },3000);
}

function isValidUrl(text){
  try { return new URL(text); } catch(e){ return null; }
}

const latestDoc = doc(db,'messages','latest');

onSnapshot(latestDoc, async (snap)=>{
  if(snap.exists()){
    const data = snap.data();
    const text = data.message || '';
    messageContent.textContent = text;
    createdAtEl.textContent = data.createdAt?.toDate?.()?.toLocaleString() || '‚Äî';

    // Auto-copy
    try{ await navigator.clipboard.writeText(text); autoCopyMsg.style.display='block'; }
    catch(e){ console.warn('Kh√¥ng th·ªÉ auto copy',e); }

    // M·ªü link t·ª± ƒë·ªông n·∫øu l√† URL
    const url = isValidUrl(text);
    if(url){
      window.location.href = url.href;
    }

    // Button v·∫´n xu·∫•t hi·ªán nh∆∞ng ch·ªâ d√πng cho ng∆∞·ªùi mu·ªën b·∫•m
    openLinkBtn.onclick = url ? ()=>{ window.open(url.href,'_blank'); } : null;

    // Popup toast khi tin nh·∫Øn m·ªõi
    if(text && text !== lastMessage){
      lastMessage = text;
      showToast('üì© Tin nh·∫Øn m·ªõi: ' + text);
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Tin nh·∫Øn m·ªõi', { body: text });
      } else if('Notification' in window && Notification.permission !== 'denied'){
        Notification.requestPermission();
      }
    }

  } else {
    messageContent.textContent = 'Ch∆∞a c√≥ tin nh·∫Øn';
    createdAtEl.textContent = '‚Äî';
  }
});
</script>
</body>
</html>
